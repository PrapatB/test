version: 2
jobs:
  build:
    docker:
      # CircleCI Go images available at: https://hub.docker.com/r/circleci/golang/
      - image: circleci/golang:1.10.1
    working_directory: ~/ndid/test
    steps:
      - checkout
      - run:
          name: Install Node.js
          command: curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash - && sudo apt-get install -y nodejs
      - run:
          name: Install Tendermint ABCI
          command: go get github.com/tendermint/abci/cmd/abci-cli
      - run:
          name: Install Tendermint
          command: |
            wget https://github.com/tendermint/tendermint/releases/download/v0.18.0-autodraft/tendermint_0.18.0_linux_amd64.zip
            unzip tendermint_0.18.0_linux_amd64.zip
            sudo install tendermint /usr/local/bin
      - run:
          name: Install project dependencies (todo use a dep management solution?)
          command: |
            go get github.com/fatih/color
      - run:
          name: Create logs directory
          command: |
            mkdir -p ~/logs
      - run: git clone https://github.com/ndidplatform/smart-contract.git /go/src/github.com/ndidplatform/smart-contract
      - run: git clone https://github.com/ndidplatform/api.git ~/ndid/api
      - run:
          name: idp-abci
          command: |
            (
              cd /go/src/github.com/ndidplatform/smart-contract
              CALLBACK_URI=http://localhost:3000/callback go run abci/server.go tcp://127.0.0.1:46000
            ) 2>&1 | tee -a ~/logs/idp-abci.log
          background: true
      - run:
          name: idp-tendermint
          command: |
            (
              cd /go/src/github.com/ndidplatform/smart-contract
              tendermint --home ./config/tendermint/IdP unsafe_reset_all
              tendermint --home ./config/tendermint/IdP node --consensus.create_empty_blocks=false
            ) 2>&1 | tee -a ~/logs/idp-tendermint.log
          background: true
      - run:
          name: rp-abci
          command: |
            (
              cd /go/src/github.com/ndidplatform/smart-contract
              CALLBACK_URI=http://localhost:3001/callback go run abci/server.go tcp://127.0.0.1:46001
            ) 2>&1 | tee -a ~/logs/rp-abci.log
          background: true
      - run:
          name: rp-tendermint
          command: |
            (
              cd /go/src/github.com/ndidplatform/smart-contract
              tendermint --home ./config/tendermint/RP unsafe_reset_all
              tendermint --home ./config/tendermint/RP node --consensus.create_empty_blocks=false
            ) 2>&1 | tee -a ~/logs/rp-tendermint.log
          background: true
      - run: sleep 20
      - store_artifacts:
          path: ~/logs
          destination: logs
